@using Microsoft.AspNetCore.Http.Features
@{
    var consentFeatureFlag = Context.Features.Get<ITrackingConsentFeature>();
    var showBannerFlag = !consentFeatureFlag?.CanTrack ?? false;
    var cookieString = consentFeatureFlag?.CreateConsentCookie();
}

@if (showBannerFlag)
{
    <div id="cookieConsentdiv"
         class="cookie-fixed start-50 translate-middle-x alert alert-secondary shadow-lg rounded-4 p-3 text-center">
        <h3 class="display-6">Vår cookie-policy</h3>
        <p>Vi använder endast nödvändiga cookies för att webbplatsen ska fungera korrekt. Genom att klicka på Acceptera godkänner du detta – och du slipper dessutom se den här rutan igen.</p>
        <a href="#" id="showPrivacyContent">Läs mer här</a>
        <div id="privacyContent" style="display:none; margin-top:1em;">
            @await Html.PartialAsync("_PrivacyContent")
        </div>
        <button type="button" data-cookie-string="@cookieString" class="btn btn-primary mt-2">
            Acceptera
        </button>
    </div>

    <script>
        (function () {
            const banner = document.getElementById("cookieConsentdiv");
            const body = document.body;

            // HJÄLPARE: kolla om consent-cookien redan finns (utan localStorage)
            function hasConsent() {
                return document.cookie.split("; ").some(c => c.indexOf(".AspNet.Consent=") === 0)
                    || document.cookie.includes(".AspNet.Consent=yes");
            }

            // Om cookien redan finns → göm direkt (utan reload)
            if (hasConsent()) {
                if (banner) banner.style.display = "none";
                return;
            }

            // Visa/dölj sekretessinnehåll
            const toggle = document.getElementById("showPrivacyContent");
            if (toggle) {
                toggle.addEventListener("click", function (e) {
                    e.preventDefault();
                    const box = document.getElementById("privacyContent");
                    const show = box.style.display !== "block";
                    box.style.display = show ? "block" : "none";
                    toggle.textContent = show ? "Visa mindre" : "Läs mer här";
                    body.classList.toggle("modal-open", show);
                });
            }

            // Klick på Acceptera → sätt samtyckes-cookie och göm bannern (ingen reload)
            const btn = banner && banner.querySelector("button[data-cookie-string]");
            if (btn) {
                btn.addEventListener("click", function () {
                    // Sätt den server-förväntade cookien
                    // (värdet i data-cookie-string funkar också; den kan innehålla path/expiry)
                    document.cookie = btn.getAttribute("data-cookie-string");

                    // Göm bannern mjukt
                    banner.style.transition = "opacity .25s ease";
                    banner.style.opacity = "0";
                    setTimeout(() => {
                        banner.style.display = "none";
                        body.classList.remove("modal-open");
                    }, 250);

                    // OBS: ingen window.location.reload();
                });
            }
        })();
    </script>
}