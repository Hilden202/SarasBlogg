@using Microsoft.AspNetCore.Http.Features
@{
    var consentFeatureFlag = Context.Features.Get<ITrackingConsentFeature>();
    var showBannerFlag = !consentFeatureFlag?.CanTrack ?? false;
    var cookieString = consentFeatureFlag?.CreateConsentCookie();
}

@if (showBannerFlag)
{
    <div id="cookieConsentdiv"
         class="cookie-fixed start-50 translate-middle-x alert alert-secondary shadow-lg rounded-4 p-3 text-center">
        <h3 class="display-6">Vår cookie-policy</h3>
        <p>Vi använder endast nödvändiga cookies för att webbplatsen ska fungera korrekt. Genom att klicka på Acceptera godkänner du detta – och du slipper dessutom se den här rutan igen.</p>
        <a href="#" id="showPrivacyContent">Läs mer här</a>
        <div id="privacyContent" style="display:none; margin-top:1em;">
            @await Html.PartialAsync("_PrivacyContent")
        </div>
        <button type="button" data-cookie-string="@cookieString" class="btn btn-primary mt-2">
            Acceptera
        </button>
    </div>

    <script>
        (function () {
            const banner = document.getElementById("cookieConsentdiv");
            const body = document.body;
            if (!banner) return;

            // --- helpers ---
            const has = (name, val) =>
                document.cookie.split("; ").some(c =>
                    c.indexOf(name + "=") === 0 && (!val || c.endsWith("=" + val))
                );

            // Endast cookies avgör om vi redan accepterat
            const accepted =
                has(".AspNetCore.Consent", "yes") ||
                has(".AspNet.Consent", "yes");

            if (accepted) {
                banner.style.display = "none";
                return;
            }

            // Läs mer / Visa mindre
            const toggle = document.getElementById("showPrivacyContent");
            if (toggle) {
                toggle.addEventListener("click", function (e) {
                    e.preventDefault();
                    const box = document.getElementById("privacyContent");
                    const show = box.style.display !== "block";
                    box.style.display = show ? "block" : "none";
                    toggle.textContent = show ? "Visa mindre" : "Läs mer här";
                    body.classList.toggle("modal-open", show);
                });
            }

            // Accept
            const btn = banner.querySelector("button[data-cookie-string]");
            if (!btn) return;

            btn.addEventListener("click", function () {
                // 1) Sätt den cookie-sträng som servern gav (rätt namn/attribut för din miljö)
                const serverCookie = btn.getAttribute("data-cookie-string");
                if (serverCookie) document.cookie = serverCookie;

                // 2) Sätt båda vanliga namnen explicit (failsafe mellan .AspNetCore.Consent / .AspNet.Consent)
                const secure = location.protocol === "https:" ? "; Secure" : "";
                const commonAttrs = "; Path=/; Max-Age=31536000; SameSite=Lax" + secure;
                document.cookie = ".AspNetCore.Consent=yes" + commonAttrs;
                document.cookie = ".AspNet.Consent=yes" + commonAttrs;

                // 3) Göm mjukt (ingen reload)
                banner.style.transition = "opacity .25s ease";
                banner.style.opacity = "0";
                setTimeout(() => {
                    banner.style.display = "none";
                    body.classList.remove("modal-open");
                }, 250);
            });
        })();
    </script>

}