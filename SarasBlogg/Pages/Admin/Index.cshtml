@page
@model SarasBlogg.Pages.Admin.IndexModel
@{
    var todaySE = DateTime.UtcNow.ToSwedishTime().Date;
}

<div class="container-site">
    @if (Model.IsAdmin || Model.IsSuperAdmin)
    {
        <nav class="border-bottom">
            <div class="container d-flex justify-content-center">
                <ul class="mynav">
                    <li class="nav-item me-3">
                        <a class="menutext nav-link theme-dependent fw-bold" asp-area="" asp-page="/Admin/Index">Bloggar</a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="menutext nav-link theme-dependent" asp-area="" asp-page="/Admin/RoleAdmin/Index">Roller</a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="menutext nav-link theme-dependent" asp-area="" asp-page="/Admin/ForbiddenWords/Index">Ord</a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- LISTA PUBLICERADE BLOGGAR -->
        <h2>Lista Publicerade Bloggar</h2>
        @if (Model.BloggsWithImage != null && Model.BloggsWithImage.Any(b => !b.Blogg.Hidden))
        {
            <div class="table-responsive-lg">
                <table class="border table table-striped shadow-sm align-middle admin-table">
                    <thead>
                        <tr>
                            <th class="text-center align-middle border d-none d-md-table-cell" colspan="3">Knappar</th>
                            <th class="text-center align-middle border d-table-cell d-md-none" colspan="1">Knappar</th>
                            <th class="text-center align-middle border">Id</th>
                            <th class="text-center align-middle border">Titel</th>
                            <th class="text-center align-middle border d-none d-md-table-cell">Innehåll</th>
                            <th class="text-center align-middle border d-none d-md-table-cell">Författare</th>
                            <th class="text-center align-middle border d-none d-md-table-cell">Lanserings Datum</th>
                            <th class="text-center align-middle border d-none d-md-table-cell">Bild</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.BloggsWithImage.Where(b => !b.Blogg.Hidden))
                        {
                            <tr>
                                <td class="text-center align-middle d-none d-md-table-cell" colspan="3">
                                    <div class="admin-btn-group">
                                        <form method="get" class="me-1">
                                            <input type="hidden" name="hiddenId" value="@item.Blogg.Id" />
                                            <button type="submit" class="btn btn-outline-warning">Dölj</button>
                                        </form>
                                        @if (item.Blogg.IsArchived)
                                        {
                                            <a asp-route-archiveId="@item.Blogg.Id" class="btn btn-outline-warning ms-1">Arkiverad</a>
                                        }
                                        else
                                        {
                                            <a asp-route-archiveId="@item.Blogg.Id" class="btn btn-outline-success ms-1">Publicerad</a>
                                        }
                                        <a asp-route-editId="@item.Blogg.Id" class="btn btn-outline-primary ms-1">Ändra</a>
                                    </div>
                                </td>
                                <td class="text-center align-middle d-table-cell d-md-none">
                                    <div class="d-flex flex-column gap-1">
                                        <form method="get">
                                            <input type="hidden" name="hiddenId" value="@item.Blogg.Id" />
                                            <button type="submit" class="btn btn-outline-warning w-100">Dölj</button>
                                        </form>
                                        @if (item.Blogg.IsArchived)
                                        {
                                            <a asp-route-archiveId="@item.Blogg.Id" class="btn btn-outline-warning w-100">Arkiverad</a>
                                        }
                                        else
                                        {
                                            <a asp-route-archiveId="@item.Blogg.Id" class="btn btn-outline-success w-100">Publicerad</a>
                                        }
                                        <a asp-route-editId="@item.Blogg.Id" class="btn btn-outline-primary w-100">Ändra</a>
                                    </div>
                                </td>
                                <td class="text-center align-middle border">@item.Blogg.Id</td>
                                <td class="text-lg-start align-middle border title-cell">
                                    @item.Blogg.Title
                                    <div class="d-md-none small text-muted mt-1">
                                        Förf: @item.Blogg.Author •
                                        <span style="color: @(item.Blogg.LaunchDate.ToSwedishTime().Date > todaySE ? "orange" : "green")">
                                            @item.Blogg.LaunchDate.ToSwedishTime().ToString("yyyy-MM-dd")
                                        </span>
                                    </div>
                                    @{
                                        var imageUrl_m = item.FirstImage?.FilePath;
                                        var isExternal_m = !string.IsNullOrEmpty(imageUrl_m) &&
                                        (imageUrl_m.StartsWith("http://") || imageUrl_m.StartsWith("https://"));
                                    }
                                    @if (!string.IsNullOrWhiteSpace(imageUrl_m))
                                    {
                                        <div class="d-md-none mt-1">
                                            <img class="image-inline"
                                                 src="@(isExternal_m ? imageUrl_m : Url.Content(imageUrl_m))"
                                                 onerror="this.onerror=null; this.src='/img/blogg/default.png';"
                                                 alt="Förhandsbild" />
                                        </div>
                                    }
                                </td>
                                <td class="text-lg-start align-middle border d-none d-md-table-cell">@item.Blogg.Content?.LimitLength(10)</td>
                                <td class="text-center align-middle border d-none d-md-table-cell">@item.Blogg.Author</td>
                                <td class="text-center align-middle border d-none d-md-table-cell">
                                    <span style="color: @(item.Blogg.LaunchDate.ToSwedishTime().Date > todaySE ? "orange" : "green")">
                                        @item.Blogg.LaunchDate.ToSwedishTime().ToString("yyyy-MM-dd")
                                    </span>
                                </td>
                                <td class="text-center align-middle border image-column d-none d-md-table-cell">
                                    @{
                                        var imageUrl = item.FirstImage?.FilePath;
                                        var isExternal = !string.IsNullOrEmpty(imageUrl) &&
                                        (imageUrl.StartsWith("http://") || imageUrl.StartsWith("https://"));
                                    }
                                    <img class="admin-blog-img"
                                         src="@(isExternal ? imageUrl : Url.Content(imageUrl ?? "/img/blogg/default.png"))"
                                         onerror="this.onerror=null; this.src='/img/blogg/default.png';"
                                         alt="Förhandsbild" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p>Ingen blogg finns att visa.</p>
        }

        <br />
        <hr class="m-1 border" />
        <br />

        <!-- FORMULÄR FÖR NY BLOGG / ÄNDRING -->
        <div id="editFormSection">
            <form id="blogForm" class="white-panel p-3 border rounded shadow-sm" method="post" enctype="multipart/form-data" novalidate>
                <div class="text-danger mb-2">
                    @Html.ValidationSummary(excludePropertyErrors: true)
                </div>

                <input asp-for="NewBlogg.Id" type="hidden" />
                <input asp-for="NewBlogg.UserId" type="hidden" />

                <label asp-for="NewBlogg.Title"></label>
                <input asp-for="NewBlogg.Title" class="form-control" placeholder="Ange bloggtitel här" maxlength="100" />
                <span asp-validation-for="NewBlogg.Title" class="text-danger"></span>
                <br />

                <label asp-for="NewBlogg.Content"></label>
                <textarea asp-for="NewBlogg.Content" class="form-control" placeholder="Ange innehåll här" rows="10" cols="60"></textarea>
                <span asp-validation-for="NewBlogg.Content" class="text-danger"></span>
                <br />

                <label asp-for="NewBlogg.Author"></label>
                <input asp-for="NewBlogg.Author" class="form-control" placeholder="Ange författare här" maxlength="100" />
                <span asp-validation-for="NewBlogg.Author" class="text-danger"></span>
                <br />

                <label asp-for="NewBlogg.LaunchDate"></label>
                <input asp-for="NewBlogg.LaunchDate" type="date" asp-format="{0:yyyy-MM-dd}" class="form-control" />

                <span asp-validation-for="NewBlogg.LaunchDate" class="text-danger"></span>
                <br />

                <!-- Bildhantering -->
                <label asp-for="BloggImages">Ladda upp en eller flera bilder:</label>
                <input asp-for="BloggImages" data-val="false" type="file" multiple
                       accept=".jpg,.jpeg,.png,.webp,.gif,image/jpeg,image/png,image/webp,image/gif"
                       class="form-control" />
                <br />

                @if (Model.EditedBloggWithImages?.Images?.Any() == true)
                {
                    var firstImageId = Model.EditedBloggWithImages.FirstImage?.Id;
                    var firstImage = Model.EditedBloggWithImages.FirstImage;

                    <div class="mb-3">
                        <label>Nuvarande bilder:</label><br />
                        <div class="d-flex flex-wrap gap-2">
                            @if (firstImage != null)
                            {
                                <div class="d-flex flex-column align-items-center d-none">
                                    <div class="img-wrapper position-relative">
                                        <img src="@firstImage.FilePath"
                                             class="admin-blog-img border rounded"
                                             onerror="this.onerror=null; this.src='/img/blogg/default.png';"
                                             alt="Första bloggbild" />
                                    </div>
                                </div>
                            }
                            @foreach (var img in Model.EditedBloggWithImages.Images)
                            {
                                var isFirst = img.Id == Model.EditedBloggWithImages.FirstImage?.Id;

                                <div class="d-flex flex-column align-items-center">
                                    <div class="img-wrapper position-relative">
                                        <img src="@img.FilePath"
                                             class="admin-blog-img border rounded"
                                             onerror="this.onerror=null; this.src='/img/blogg/default.png';"
                                             alt="Bloggbild" />

                                        <input type="hidden" name="bloggId" value="@Model.EditedBloggWithImages.Blogg.Id" />

                                        <button type="submit"
                                                asp-page-handler="DeleteImage"
                                                asp-route-imageId="@img.Id"
                                                asp-route-bloggId="@Model.EditedBloggWithImages.Blogg.Id"
                                                formnovalidate
                                                class="btn btn-sm btn-danger p-1"
                                                data-busy-text="Tar bort…"
                                                onclick="return confirm('Ta bort bilden?')">
                                            &times;
                                        </button>
                                    </div>

                                    @if (isFirst)
                                    {
                                        <small class="text-info mt-1">Första bild</small>
                                    }
                                    else
                                    {
                                        <button type="submit"
                                                asp-page-handler="SetFirstImage"
                                                asp-route-imageId="@img.Id"
                                                asp-route-bloggId="@Model.EditedBloggWithImages.Blogg.Id"
                                                formnovalidate
                                                class="btn btn-sm btn-outline-primary"
                                                data-busy-text="Uppdaterar…">
                                            Gör till första bild
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }

                <button id="saveBtn" type="submit" class="btn btn-success" data-busy-text="Sparar…">
                    Skapa ny blogg/spara ändringar
                </button>
            </form>
        </div>

        <br />
        <hr class="m-1 border" />
        <br />

        <!-- LISTA DOLDA BLOGGAR -->
        <h2>Lista Dolda Bloggar</h2>
        @if (Model.BloggsWithImage != null && Model.BloggsWithImage.Any(b => b.Blogg.Hidden))
        {
            <div class="table-responsive-lg">
                <table class="border table table-striped shadow-sm align-middle admin-table">
                    <thead>
                        <tr>
                            <th class="text-center align-middle border d-none d-md-table-cell" colspan="3">Knappar</th>
                            <th class="text-center align-middle border d-table-cell d-md-none" colspan="1">Knappar</th>
                            <th class="text-center align-middle border">Id</th>
                            <th class="text-center align-middle border">Titel</th>
                            <th class="text-center align-middle border d-none d-md-table-cell">Innehåll</th>
                            <th class="text-center align-middle border d-none d-md-table-cell">Författare</th>
                            <th class="text-center align-middle border d-none d-md-table-cell">Lanserings Datum</th>
                            <th class="text-center align-middle border d-none d-md-table-cell">Bild</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.BloggsWithImage.Where(b => b.Blogg.Hidden))
                        {
                            <tr>
                                <td class="text-center align-middle d-none d-md-table-cell" colspan="3">
                                    <div class="admin-btn-group">
                                        <form method="get" class="me-1">
                                            <input type="hidden" name="deleteId" value="@item.Blogg.Id" />
                                            <button type="submit" class="btn btn-outline-danger">Ta bort</button>
                                        </form>
                                        <a asp-route-hiddenId="@item.Blogg.Id" class="btn btn-outline-success">Visa</a>
                                        <a asp-route-editId="@item.Blogg.Id" class="btn btn-outline-primary">Ändra</a>
                                    </div>
                                </td>
                                <td class="text-center align-middle d-table-cell d-md-none">
                                    <div class="d-flex flex-column gap-1">
                                        <form method="get">
                                            <input type="hidden" name="deleteId" value="@item.Blogg.Id" />
                                            <button type="submit" class="btn btn-outline-danger w-100">Ta bort</button>
                                        </form>
                                        <a asp-route-hiddenId="@item.Blogg.Id" class="btn btn-outline-success w-100">Visa</a>
                                        <a asp-route-editId="@item.Blogg.Id" class="btn btn-outline-primary w-100">Ändra</a>
                                    </div>
                                </td>
                                <td class="text-center align-middle border">@item.Blogg.Id</td>
                                <td class="text-lg-start align-middle border title-cell">
                                    @item.Blogg.Title
                                    <div class="d-md-none small text-muted mt-1">
                                        Förf: @item.Blogg.Author •
                                        <span style="color: @(item.Blogg.LaunchDate.ToSwedishTime().Date > todaySE ? "orange" : "green")">
                                            @item.Blogg.LaunchDate.ToSwedishTime().ToString("yyyy-MM-dd")
                                        </span>
                                    </div>
                                    @{
                                        var imageUrl_m = item.FirstImage?.FilePath;
                                        var isExternal_m = !string.IsNullOrEmpty(imageUrl_m) &&
                                        (imageUrl_m.StartsWith("http://") || imageUrl_m.StartsWith("https://"));
                                    }
                                    @if (!string.IsNullOrWhiteSpace(imageUrl_m))
                                    {
                                        <div class="d-md-none mt-1">
                                            <img class="image-inline"
                                                 src="@(isExternal_m ? imageUrl_m : Url.Content(imageUrl_m))"
                                                 onerror="this.onerror=null; this.src='/img/blogg/default.png';"
                                                 alt="Förhandsbild" />
                                        </div>
                                    }
                                </td>
                                <td class="text-lg-start align-middle border d-none d-md-table-cell">@item.Blogg.Content?.LimitLength(10)</td>
                                <td class="text-center align-middle border d-none d-md-table-cell">@item.Blogg.Author</td>
                                <td class="text-center align-middle border d-none d-md-table-cell">
                                    <span style="color: @(item.Blogg.LaunchDate.ToSwedishTime().Date > todaySE ? "orange" : "green")">
                                        @item.Blogg.LaunchDate.ToSwedishTime().ToString("yyyy-MM-dd")
                                    </span>
                                </td>
                                <td class="text-center align-middle border image-column d-none d-md-table-cell">
                                    @{
                                        var imageUrl = item.FirstImage?.FilePath;
                                        var isExternal = !string.IsNullOrEmpty(imageUrl) &&
                                        (imageUrl.StartsWith("http://") || imageUrl.StartsWith("https://"));
                                    }
                                    <img class="admin-blog-img"
                                         src="@(isExternal ? imageUrl : Url.Content(imageUrl ?? "/img/blogg/default.png"))"
                                         onerror="this.onerror=null; this.src='/img/blogg/default.png';"
                                         alt="Förhandsbild" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p>Ingen dold blogg finns att visa.</p>
        }
    }
    else
    {
        <p class="text-danger">Du måste vara inloggad för att komma åt denna sida.</p>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
          const form = document.getElementById("blogForm");
          if (!form) return;

          form.addEventListener("submit", (e) => {
            // Låt HTML5-validering hindra submit om något är fel (annars fastnar knappen)
            if (!form.checkValidity()) return;

            // Lås endast den knapp som faktiskt skickade
            const btn = e.submitter;
            if (!btn) return;
            if (btn.disabled) { e.preventDefault(); return; }

            const busyText = btn.getAttribute("data-busy-text") || "Sparar…";
            btn.disabled = true;
            btn.textContent = busyText;
          });
        });
    </script>
}
