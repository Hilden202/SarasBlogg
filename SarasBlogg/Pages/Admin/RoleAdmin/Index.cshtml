@page
@model SarasBlogg.Pages.Admin.RoleAdmin.IndexModel

<div class="container-site">
    @if (User.IsInRole("admin") || User.IsInRole("superadmin"))
    {
        <nav class="border-bottom">
            <div class="container d-flex justify-content-center">
                <ul class="mynav">
                    <li class="nav-item me-3">
                        <a class="menutext nav-link theme-dependent" asp-area="" asp-page="/Admin/Index">Bloggar</a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="menutext nav-link theme-dependent fw-bold" asp-area="" asp-page="/Admin/RoleAdmin/Index">Roller</a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="menutext nav-link theme-dependent" asp-area="" asp-page="/Admin/ForbiddenWords/Index">Ord</a>
                    </li>
                </ul>
            </div>
        </nav>

        <h2>Användare och Roller</h2>

        <p>Antal användare: @Model.Users?.Count</p>
        <p>Antal roller: @Model.Roles?.Count</p>

        <table class="border table table-striped shadow-sm align-middle">
            <thead>
                <tr>
                    <th>Ta bort</th>
                    <th>Användare</th>
                    <th>Byt användarnamn</th>
                    @foreach (var role in Model.Roles)
                    {
                        <th>@role</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model.Users)
                {
                    var isSystemAdmin = (user.Email ?? "").ToLower() == "admin@sarasblogg.se";
                    <tr>
                        <!-- Ta bort -->
                        <td>
                            @if (!isSystemAdmin)
                            {
                                <form method="post" asp-page-handler="DeleteUser"
                                      onsubmit="return confirm('Ta bort användare @user.Email?')">
                                    <input type="hidden" name="DeleteUserId" value="@user.Id" />
                                    <button class="btn btn-sm btn-outline-danger">🗑</button>
                                </form>
                            }
                        </td>

                        <!-- Användare (visning) -->
                        <td>
                            <div><strong>@user.UserName</strong> (@user.Email)</div>
                            <div><small>Roller: @string.Join(", ", user.Roles)</small></div>
                        </td>

                        <!-- Byt användarnamn -->
                        <td>
                            @if (User.IsInRole("superadmin") && !isSystemAdmin)
                            {
                                <form method="post" asp-page-handler="ChangeUserName" class="d-flex gap-2">
                                    <input type="hidden" name="TargetUserId" value="@user.Id" />
                                    <input type="text"
                                           name="NewUserName"
                                           value="@user.UserName"
                                           class="form-control form-control-sm"
                                           style="max-width: 220px"
                                           placeholder="Nytt användarnamn" />
                                    <button class="btn btn-sm btn-outline-primary">Byt</button>
                                </form>
                            }
                            else
                            {
                                <span class="text-muted">—</span>
                            }
                        </td>

                        <!-- Roll-matris som förr -->
                        @foreach (var role in Model.Roles)
                        {
                            <td>
                                @if (isSystemAdmin)
                                {
                                    <span class="btn btn-sm btn-outline-secondary disabled">Ja</span>
                                }
                                else if (user.Roles.Contains(role))
                                {
                                    <a class="btn btn-sm btn-outline-danger"
                                       href="?RemoveUserId=@user.Id&amp;RoleName=@role">Ja</a>
                                }
                                else
                                {
                                    <a class="btn btn-sm btn-outline-success"
                                       href="?AddUserId=@user.Id&amp;RoleName=@role">Nej</a>
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>

        <form method="post" class="mt-4">
            <label for="RoleName">Ny Roll</label>
            <input type="text" name="RoleName" id="RoleName" class="form-control" />
            <input type="submit" value="Skapa ny roll" class="btn btn-primary mt-2" />
        </form>

        <hr />
        <h4>Hantera roller</h4>
        <table class="table table-bordered w-auto">
            <thead>
                <tr>
                    <th>Roll</th>
                    <th>Ta bort</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var role in Model.Roles)
                {
                    <tr>
                        <td>@role</td>
                        <td>
                            @if (role.ToLower() != "superadmin")
                            {
                                <form method="post" asp-page-handler="DeleteRole">
                                    <input type="hidden" name="DeleteRoleName" value="@role" />
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Ta bort rollen @role?')">🗑</button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>
