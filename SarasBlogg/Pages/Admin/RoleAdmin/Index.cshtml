@page
@model SarasBlogg.Pages.Admin.RoleAdmin.IndexModel

<div class="container-site">
    @if (Model.IsApiAdminOrSuper)
    {
        <nav class="border-bottom">
            <div class="container d-flex justify-content-center">
                <ul class="mynav">
                    <li class="nav-item me-3">
                        <a class="menutext nav-link theme-dependent" asp-area="" asp-page="/Admin/Index">Bloggar</a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="menutext nav-link theme-dependent fw-bold" asp-area="" asp-page="/Admin/RoleAdmin/Index">Roller</a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="menutext nav-link theme-dependent" asp-area="" asp-page="/Admin/ForbiddenWords/Index">Ord</a>
                    </li>
                </ul>
            </div>
        </nav>

        <h2>Användare och Roller</h2>

        <p>Antal användare: @Model.Users?.Count</p>
        <p>Antal roller: @Model.Roles?.Count</p>

        <table class="border table table-striped shadow-sm align-middle">
            <thead>
                <tr>
                    <th>Ta bort</th>
                    <th>Användare</th>
                    <th>Byt användarnamn</th>
                    @foreach (var role in Model.Roles)
                    {
                        <th>@role</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model.Users)
                {
                    var isSysAdmin = Model.IsSystemAdmin(user.Email);

                    <tr>
                        <td>
                            @if (!isSysAdmin)
                            {
                                @if (Model.IsApiSuperadmin)
                                {
                                    <form method="post" asp-page-handler="DeleteUser"
                                          onsubmit="return confirm('Ta bort användare @user.Email?')">
                                        <input type="hidden" name="DeleteUserId" value="@user.Id" />
                                        <button class="btn btn-sm btn-outline-danger">🗑</button>
                                    </form>
                                }
                                else
                                {
                                    <span class="btn btn-sm btn-outline-secondary disabled"
                                          title="Endast superadmin kan ta bort">🗑</span>
                                }
                            }
                        </td>

                        <!-- Användare (visning) -->
                        <td>
                            <div>
                                <strong>
                                    @if (isSysAdmin)
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                    else
                                    {
                                        @user.UserName
                                    }
                                </strong>
                                (@user.Email)
                            </div>
                            <div>
                                <small>Roller: @string.Join(", ", user.Roles)</small>
                            </div>
                        </td>

                        <!-- Byt användarnamn -->
                        <td>
                            @if (Model.IsApiSuperadmin && !isSysAdmin)
                            {
                                <form method="post" asp-page-handler="ChangeUserName" class="d-flex gap-2">
                                    <input type="hidden" name="TargetUserId" value="@user.Id" />
                                    <input type="text"
                                           name="NewUserName"
                                           value="@user.UserName"
                                           class="form-control form-control-sm"
                                           style="max-width: 220px"
                                           placeholder="Nytt användarnamn" />
                                    <button class="btn btn-sm btn-outline-primary">Byt</button>
                                </form>
                            }
                            else
                            {
                                <!-- Visa låst fält; för systemadmin döljs namnet -->
                                <input type="text"
                                       value="@(isSysAdmin ? "—" : user.UserName)"
                                       class="form-control form-control-sm"
                                       style="max-width: 220px"
                                       disabled
                                       title="Endast superadmin kan ändra" />
                            }
                        </td>


                        <!-- Roll-matris -->
                        @foreach (var role in Model.Roles)
                        {
                            <td>
                                @if (isSysAdmin)
                                {
                                    <span class="btn btn-sm btn-outline-secondary disabled">Ja</span>
                                }
                                else if (user.Roles.Contains(role))
                                {
                                    @if (Model.IsApiSuperadmin)
                                    {
                                        <a class="btn btn-sm btn-outline-danger"
                                           href="?RemoveUserId=@user.Id&amp;RoleName=@role">Ja</a>
                                    }
                                    else
                                    {
                                        <span class="btn btn-sm btn-outline-secondary disabled">Ja</span>
                                    }
                                }
                                else
                                {
                                    @if (Model.IsApiSuperadmin)
                                    {
                                        <a class="btn btn-sm btn-outline-success"
                                           href="?AddUserId=@user.Id&amp;RoleName=@role">Nej</a>
                                    }
                                    else
                                    {
                                        <span class="btn btn-sm btn-outline-secondary disabled">Nej</span>
                                    }
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>

        <!-- Ny roll -->
        @if (Model.IsApiSuperadmin)
        {
            <form method="post" class="mt-4">
                <label for="RoleName">Ny Roll</label>
                <input type="text" name="RoleName" id="RoleName" class="form-control" />
                <input type="submit" value="Skapa ny roll" class="btn btn-primary mt-2" />
            </form>

            <hr />
            <h4>Hantera roller</h4>
            <table class="table table-bordered w-auto">
                <thead>
                    <tr>
                        <th>Roll</th>
                        <th>Ta bort</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var role in Model.Roles)
                    {
                        <tr>
                            <td>@role</td>
                            <td>
                                @if (role.ToLower() != "superadmin")
                                {
                                    <form method="post" asp-page-handler="DeleteRole">
                                        <input type="hidden" name="DeleteRoleName" value="@role" />
                                        <button type="submit" class="btn btn-sm btn-danger"
                                                onclick="return confirm('Ta bort rollen @role?')">
                                            🗑
                                        </button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p class="text-muted mt-4">Endast superadmin kan skapa eller ta bort roller.</p>
        }
    }
</div>

@section Scripts {
    <script>
        if (window.innerWidth < 992) {
          document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[name="NewUserName"]').forEach(el => {
              el.tabIndex = -1;
              el.removeAttribute('autofocus');
            });
            setTimeout(() => document.activeElement?.blur(), 0);
          });
        }
    </script>
}
